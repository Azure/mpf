# yaml-language-server: $schema=https://taskfile.dev/schema.json
# docs: https://taskfile.dev
---
version: "3"

vars:
  RUNTIME_VERSION:
    map:
      uv: latest
      fnm: latest
      pwsh: latest
      golang: latest
  PYTHON_VERSION:
    sh: |
      [ -f .python-version ] && cat .python-version || echo "3.14"
  NODE_VERSION:
    sh: |
      [ -f .node-version ] && cat .node-version || echo "24"

tasks:
  init:node:
    desc: Initialize Node.js environment
    cmds:
      - fnm install --progress never "{{.NODE_VERSION}}"
      - cmd: |
          eval "$(fnm env --shell bash)"
          fnm use --silent-if-unchanged --install-if-missing "{{.NODE_VERSION}}"
          fnm default "{{.NODE_VERSION}}"
        platforms: [linux]
      - cmd: |
          eval "$(fnm env --shell zsh)"
          fnm use --silent-if-unchanged --install-if-missing "{{.NODE_VERSION}}"
          fnm default "{{.NODE_VERSION}}"
        platforms: [darwin]
      - cmd: |
          {{.PWSH}} '
            fnm env --shell powershell | Out-String | Invoke-Expression;
            fnm use --silent-if-unchanged --install-if-missing "{{.NODE_VERSION}}";
            fnm default "{{.NODE_VERSION}}"
          '
        platforms: [windows]
      # - node --version
    dir: "{{.ROOT_DIR}}"

  init:python:
    desc: Initialize Python environment
    cmds:
      - uv python install --default "{{.PYTHON_VERSION}}" --preview-features python-install-default
      # - python --version
    dir: "{{.ROOT_DIR}}"

  setup:uv:
    desc: uv setup
    cmds:
      - cmd: |
          ./scripts/setup_uv.sh "{{.RUNTIME_VERSION.uv}}"
        platforms: [linux]
      - task: :internal:_install:brew
        vars:
          APP: uv@{{.RUNTIME_VERSION.uv}}
      - task: :internal:_install:winget
        vars:
          APP: astral-sh.uv
          VERSION: "{{.RUNTIME_VERSION.uv}}"
    dir: "{{.TASKFILE_DIR}}"

  setup:fnm:
    desc: fnm setup
    cmds:
      - cmd: |
          ./scripts/setup_fnm.sh "{{.RUNTIME_VERSION.fnm}}"
        platforms: [linux]
      - task: :internal:_install:brew
        vars:
          APP: fnm@{{.RUNTIME_VERSION.fnm}}
      - task: :internal:_install:winget
        vars:
          APP: Schniz.fnm
          VERSION: "{{.RUNTIME_VERSION.fnm}}"
    dir: "{{.TASKFILE_DIR}}"

  setup:pwsh:
    desc: pwsh setup
    cmds:
      - cmd: |
          sudo ./scripts/setup_pwsh.sh "{{.RUNTIME_VERSION.pwsh}}"
        platforms: [linux]
      - cmd: |
          ./scripts/setup_pwsh.sh "{{.RUNTIME_VERSION.pwsh}}"
        platforms: [darwin]
      - task: :internal:_install:winget
        vars:
          APP: Microsoft.PowerShell
          VERSION: "{{.RUNTIME_VERSION.pwsh}}"
    dir: "{{.TASKFILE_DIR}}"

  setup:golang:
    desc: golang setup
    cmds:
      - cmd: |
          ./scripts/setup_golang.sh "{{.RUNTIME_VERSION.golang}}"
        platforms: [linux]
      - task: :internal:_install:brew
        vars:
          APP: golang@{{.RUNTIME_VERSION.golang}}
      - task: :internal:_install:winget
        vars:
          APP: GoLang.Go
          VERSION: "{{.RUNTIME_VERSION.golang}}"
    dir: "{{.TASKFILE_DIR}}"

  # * Setup
  setup:
    desc: Setup Runtime environments
    vars:
      ITEMS:
        - golang
        - uv
        - fnm
        - pwsh
    cmds:
      - for: { var: ITEMS }
        task: setup:{{.ITEM}}
