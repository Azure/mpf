# yaml-language-server: $schema=https://taskfile.dev/schema.json
# docs: https://taskfile.dev
#
# --- Windows ---
# winget install Task.Task
#
# --- Linux ---
# sh -c "$(curl -fsSL https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin
# echo 'command -v task >/dev/null || export PATH="$PATH:$HOME/.local/bin"' >> ~/.profile
# source ~/.profile
#
# --- macOS ---
# brew install go-task/tap/go-task
---
version: "3"

set: [pipefail]
shopt: [globstar]

dotenv: [.env, dev.env, ".{{.ENV}}/.env", "{{.ENV}}/.env"]

vars:
  PROJECT_NAME: azmpf
  BUILD_DEV_OUTPUT_DIR: bin/{{OS}}-{{ARCH}}
  BUILD_DEV_ARTIFACT: "{{.BUILD_DEV_OUTPUT_DIR}}/{{.PROJECT_NAME}}{{exeExt}}"

includes:
  internal: .taskfiles/_internal.Taskfile.yml
  runtime: .taskfiles/runtime.Taskfile.yml
  az: .taskfiles/azure.Taskfile.yml
  gh: .taskfiles/github.Taskfile.yml
  sh: .taskfiles/shell.Taskfile.yml
  go: .taskfiles/golang.Taskfile.yml
  tf: .taskfiles/terraform.Taskfile.yml
  md: .taskfiles/markdown.Taskfile.yml
  js: .taskfiles/javascript.Taskfile.yml
  yml: .taskfiles/yaml.Taskfile.yml

tasks:
  default:
    desc: List available tasks
    silent: true
    cmds:
      - task --list

  sysinfo:
    desc: Display system information
    silent: true
    cmds:
      # yamllint disable-line rule:quoted-strings
      - 'echo "OS: {{OS}}"' # windows, linux, darwin
      # yamllint disable-line rule:quoted-strings
      - 'echo "Architecture: {{ARCH}}"' # amd64, arm64, etc.
      # yamllint disable-line rule:quoted-strings
      - 'echo "CPU cores: {{numCPU}}"' # Number of CPU cores

  tools:
    desc: Install tools
    vars:
      ITEMS:
        - az
        - gh
        - sh
        - go
        - tf
        - md
        - js
        - yml
    cmds:
      - for: { var: ITEMS }
        task: "{{.ITEM}}:tools"

  lint:
    desc: Lint files
    vars:
      ITEMS:
        - gh
        - sh
        - go
        - tf
        - md
        - js
        - yml
    deps:
      - for: { var: ITEMS }
        task: "{{.ITEM}}:lint"

  init:
    desc: Initialize development environment
    silent: true
    cmds:
      - task: runtime:setup
      - task: runtime:init:node
      - task: runtime:init:python
      - task: tools
    dir: "{{.USER_WORKING_DIR}}"

  deps:
    desc: Check if dependencies are up to date
    cmds:
      - go mod tidy

  deps:verify:
    desc: Verify dependencies
    cmds:
      - go mod verify

  deps:download:
    desc: Download dependencies
    cmds:
      - go mod download

  deps:up:
    desc: Update dependencies
    deps: [deps]
    cmds:
      - go get -u ./...
      - defer:
          task: deps

  # ----------------------
  # Build
  # ----------------------

  build:mpf:
    desc: Build the az-mpf binary
    cmds:
      - go build -o {{.BUILD_DEV_ARTIFACT}} ./cmd
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - "{{.BUILD_DEV_ARTIFACT}}"

  build:verify:
    desc: Verify build of all packages
    cmds:
      - go build -v ./...

  build:
    desc: Build development binary with GoReleaser
    deps: [_build:clean]
    cmds:
      - goreleaser build --snapshot --single-target --clean --output {{.BUILD_DEV_ARTIFACT}}
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - "{{.BUILD_DEV_ARTIFACT}}"

  build:all:
    desc: Build snapshot binaries with GoReleaser
    deps: [_build:clean]
    cmds:
      - goreleaser build --snapshot --clean
    sources:
      - "**/*.go"
      - go.mod
      - go.sum

  _build:clean:
    desc: Cleanup build workspace
    cmds:
      - cmd: |
          {{.PWSH}} 'Remove-Item -Path {{.BUILD_DEV_OUTPUT_DIR}} -Recurse -Force -ErrorAction SilentlyContinue; exit 0'
        platforms: [windows]
      - cmd: rm -rf {{.BUILD_DEV_OUTPUT_DIR}}
        platforms: [linux, darwin]
      - defer:
          task: _build:output
    silent: true
    internal: true

  _build:output:
    desc: Create build output directories
    cmds:
      - cmd: |
          {{.PWSH}} 'New-Item -ItemType Directory -Force -Path {{.BUILD_DEV_OUTPUT_DIR}} -ErrorAction SilentlyContinue > $null'
        platforms: [windows]
      - cmd: mkdir -p {{.BUILD_DEV_OUTPUT_DIR}}
        platforms: [linux, darwin]
    silent: true
    internal: true

  # ----------------------
  # Test
  # ----------------------
  _testcli:validate:
    internal: true
    desc: Run CLI test generic logic
    cmds:
      - cmd: |
          {{.PRE_CMD}}
          RESULT_LINE_COUNT=$({{.CMD}} | wc -l)
          echo "Result line count: $RESULT_LINE_COUNT"
          if [ "$RESULT_LINE_COUNT" -ne {{.EXPECTED}} ]; then
            echo "Expected {{.EXPECTED}} lines, got $RESULT_LINE_COUNT"
            exit 1
          fi
          echo "Test passed: $RESULT_LINE_COUNT lines"
        platforms: [linux, darwin]
      - cmd: |
          {{.PWSH}} '
          {{.PRE_CMD}}
          $output = {{.CMD}}
          Write-Host $output
          $lineCount = ($output | Measure-Object -Line).Lines
          Write-Host "Result line count: $lineCount"
          if ($lineCount -ne {{.EXPECTED}}) {
            Write-Host "Expected {{.EXPECTED}} lines, got $lineCount"
            exit 1
          }
          Write-Host "Test passed: $lineCount lines"
          '
        platforms: [windows]

  _teste2e:run:
    internal: true
    vars:
      # yamllint disable-line rule:quoted-strings
      FORMAT: '{{if eq .GITHUB_ACTIONS "true"}}github-actions{{else}}pkgname-and-test-fails{{end}}'
    env:
      MPF_TFPATH: "{{.MPF_TFPATH}}"
      MPF_BICEPEXECPATH: "{{.MPF_BICEPEXECPATH}}"
    cmds:
      - go clean -testcache
      - gotestsum --format-hivis --format {{.FORMAT}} -- ./e2eTests -v -timeout 60m -run {{.TEST_RUN}}

  testunit:
    desc: Run unit tests
    cmds:
      # yamllint disable-line rule:quoted-strings
      - 'gotestsum --format-hivis --format {{.FORMAT}} --jsonfile "testresults.json" ./pkg/domain ./pkg/infrastructure/ARMTemplateShared ./pkg/infrastructure/mpfSharedUtils ./pkg/infrastructure/authorizationCheckers/terraform -p {{numCPU}} -timeout 5m -ldflags="{{.LDFLAGS}}" -coverprofile="coverage.out" -covermode atomic'
      - task: _test:getcover
    vars:
      TEST_NAME: "{{if gt (len (splitArgs .CLI_ARGS)) 0}}{{index (splitArgs .CLI_ARGS) 0}}{{end}}"
      TEST_PATH: "{{if gt (len (splitArgs .CLI_ARGS)) 1}}{{index (splitArgs .CLI_ARGS) 1}}{{else}}./...{{end}}"
      # yamllint disable-line rule:quoted-strings
      FORMAT: '{{if eq .GITHUB_ACTIONS "true"}}github-actions{{else}}pkgname-and-test-fails{{end}}'
      LDFLAGS: -s -w -X main.version=testUnit

  testcli:arm:
    desc: Run CLI tests for ARM
    vars:
      # yamllint disable-line rule:quoted-strings
      EXPECTED: '{{if eq OS "windows"}}13{{else}}14{{end}}'
    cmds:
      - task: _testcli:validate
        vars:
          CMD: go run ./cmd arm --templateFilePath ./samples/templates/aks-private-subnet.json --parametersFilePath ./samples/templates/aks-private-subnet-parameters.json
          EXPECTED: "{{.EXPECTED}}"
          PRE_CMD: ""

  testcli:bicep:
    desc: Run CLI tests for Bicep
    vars:
      # yamllint disable-line rule:quoted-strings
      EXPECTED: '{{if eq OS "windows"}}13{{else}}14{{end}}'
      MPF_BICEPEXECPATH:
        sh: |
          {{if eq OS "windows"}}
            {{.PWSH}} '$c = Get-Command bicep -ErrorAction SilentlyContinue; if ($c) { $c.Source } else { Write-Error "Bicep executable not found. Please install Bicep."; exit 1 }'
          {{else}}
            which bicep
          {{end}}
    env:
      MPF_BICEPEXECPATH: "{{.MPF_BICEPEXECPATH}}"
    cmds:
      - task: _testcli:validate
        vars:
          CMD: go run ./cmd bicep --bicepFilePath ./samples/bicep/aks-private-subnet.bicep --parametersFilePath ./samples/bicep/aks-private-subnet-params.json --bicepExecPath "{{.MPF_BICEPEXECPATH}}"
          EXPECTED: "{{.EXPECTED}}"
          PRE_CMD: ""

  testcli:terraform:
    desc: Run CLI tests for Terraform
    vars:
      # yamllint disable-line rule:quoted-strings
      EXPECTED: '{{if eq OS "windows"}}12{{else}}13{{end}}'
      MPF_TFPATH:
        sh: |
          {{if eq OS "windows"}}
            {{.PWSH}} '$c = Get-Command terraform -ErrorAction SilentlyContinue; if ($c) { $c.Source } else { Write-Error "Terraform executable not found. Please install Terraform."; exit 1 }'
          {{else}}
            which terraform
          {{end}}
    env:
      MPF_TFPATH: "{{.MPF_TFPATH}}"
    cmds:
      - task: _testcli:validate
        vars:
          CMD: go run ./cmd terraform --workingDir ./samples/terraform/aci --varFilePath ./samples/terraform/aci/dev.vars.tfvars --tfPath "{{.MPF_TFPATH}}"
          EXPECTED: "{{.EXPECTED}}"
          PRE_CMD: |
            echo "Terraform path: $MPF_TFPATH"

  teste2e:arm:
    desc: Run E2E tests for ARM
    cmds:
      - task: _teste2e:run
        vars: { TEST_RUN: TestARM }

  teste2e:bicep:
    desc: Run E2E tests for Bicep
    vars:
      MPF_BICEPEXECPATH:
        sh: |
          {{if eq OS "windows"}}
            {{.PWSH}} '$c = Get-Command bicep -ErrorAction SilentlyContinue; if ($c) { $c.Source } else { Write-Error "Bicep executable not found. Please install Bicep."; exit 1 }'
          {{else}}
            which bicep
          {{end}}
    cmds:
      - task: _teste2e:run
        vars:
          TEST_RUN: TestBicep
          MPF_BICEPEXECPATH: "{{.MPF_BICEPEXECPATH}}"

  teste2e:terraform:
    desc: Run E2E tests for Terraform
    vars:
      MPF_TFPATH:
        sh: |
          {{if eq OS "windows"}}
            {{.PWSH}} '$c = Get-Command terraform -ErrorAction SilentlyContinue; if ($c) { $c.Source } else { Write-Error "Terraform executable not found. Please install Terraform."; exit 1 }'
          {{else}}
            which terraform
          {{end}}
    cmds:
      - task: _teste2e:run
        vars:
          TEST_RUN: TestTerraform
          MPF_TFPATH: "{{.MPF_TFPATH}}"

  testacc:
    desc: Run acceptance tests
    cmds:
      - go clean -testcache
      # yamllint disable-line rule:quoted-strings
      - 'gotestsum --format-hivis --format {{.FORMAT}} --jsonfile "testresults.json" -- {{.TEST_PATH}} -run "^TestAcc_{{.TEST_NAME}}" -p {{numCPU}} -timeout 30m -ldflags="{{.LDFLAGS}}" -coverprofile="coverage.out" -covermode atomic'
      - task: _test:getcover
    vars:
      TEST_NAME: "{{if gt (len (splitArgs .CLI_ARGS)) 0}}{{index (splitArgs .CLI_ARGS) 0}}{{end}}"
      TEST_PATH: "{{if gt (len (splitArgs .CLI_ARGS)) 1}}{{index (splitArgs .CLI_ARGS) 1}}{{else}}./...{{end}}"
      # yamllint disable-line rule:quoted-strings
      FORMAT: '{{if eq .GITHUB_ACTIONS "true"}}github-actions{{else}}pkgname-and-test-fails{{end}}'
      LDFLAGS: -s -w -X main.version=testAcc

  test:
    desc: Run tests
    cmds:
      - go clean -testcache
      - go test -failfast -run ^TestDevEnv_WellKnown$ ./internal/testhelp
      # yamllint disable-line rule:quoted-strings
      - 'gotestsum --format-hivis --format {{.FORMAT}} --jsonfile "testresults.json" -- {{.TEST_PATH}} -run "^Test(Acc|Unit)_{{.TEST_NAME}}" -p {{numCPU}} -timeout 30m -ldflags="{{.LDFLAGS}}" -coverprofile="coverage.out" -covermode atomic -coverpkg={{.GO_PKGS}}'
      - task: _test:getcover
    vars:
      TEST_NAME: "{{if gt (len (splitArgs .CLI_ARGS)) 0}}{{index (splitArgs .CLI_ARGS) 0}}{{end}}"
      TEST_PATH: "{{if gt (len (splitArgs .CLI_ARGS)) 1}}{{index (splitArgs .CLI_ARGS) 1}}{{else}}./...{{end}}"
      # yamllint disable-line rule:quoted-strings
      FORMAT: '{{if eq .GITHUB_ACTIONS "true"}}github-actions{{else}}pkgname-and-test-fails{{end}}'
      LDFLAGS: -s -w -X main.version=testAcc
      GO_PKGS_EXCLUDE: /testhelp|/fakes|/terraform-provider-fabric
      GO_PKGS:
        sh: |
          {{if eq OS "windows"}}
            {{.PWSH}} "(go list ./... | Select-String -NotMatch '({{ .GO_PKGS_EXCLUDE }})$') -join ','"
          {{else}}
            go list ./... | grep -Ev '({{ .GO_PKGS_EXCLUDE }})$' | tr '\n' ','
          {{end}}
    env:
      TF_LOG: error
      TF_ACC: 1

  _test:getcover:
    desc: Get coverage results
    internal: true
    cmds:
      - cmd: |
          {{ .PWSH }} 'Get-Content coverage.out | gocover-cobertura > coverage.xml'
        platforms: [windows]
      - cmd: gocover-cobertura < coverage.out > coverage.xml
        platforms: [linux, darwin]
      - go tool cover -html coverage.out -o coverage.html

  # ----------------------
  # Release
  # ----------------------
  release:prep:
    desc: Prepare release
    vars:
      SEMVER:
        sh: semver up beta

    env:
      CHANGIE_GITHUB_REPOSITORY: microsoft/terraform-provider-fabric
    cmds:
      - echo "{{.SEMVER}}"
      - cmd: |
          git checkout main && git fetch && git pull
          git checkout -b "release/{{.SEMVER}}"
      - changie batch {{.SEMVER}}
      - changie merge
      - task: docs
      - cmd: |
          git add .
          git commit -a -m "feat(release): {{.SEMVER}}"
      - cmd: |
          gh pr create --title "feat(release): {{.SEMVER}}" --body-file ".changes/{{.SEMVER}}.md" --label "skip-changelog"

  diff:
    desc: Check for differences
    silent: true
    status:
      - git diff --shortstat --exit-code
    cmds:
      - cmd: |
          echo "âš ï¸âš ï¸âš ï¸ Unexpected difference. Run 'task {{.CLI_ARGS}}' command and commit. âš ï¸âš ï¸âš ï¸"
          echo
          echo "ğŸ›‘ğŸ›‘ğŸ›‘ Uncommitted changes ğŸ›‘ğŸ›‘ğŸ›‘"
          echo
          git status --short
          echo
          echo "ğŸ“ğŸ“ğŸ“ Summary ğŸ“ğŸ“ğŸ“"
          echo
          git diff --compact-summary
          echo
          echo "ğŸ”ğŸ”ğŸ” Differences ğŸ”ğŸ”ğŸ”"
          echo
          git --no-pager diff
          echo
          exit 1
